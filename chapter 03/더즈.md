# 3장 HTTP 정보는 HTTP 메시지에 있다.

## HTTP 메시지

- HTTP 메시지는 복수 행(개행 문자는 CR+LF)의 데이터로 구성된 텍스트 문자열이다.
- HTTP 메시지는 헤더와 바디로 구분 되어 있다.
- 최초에 나타나는 개행 문자로 헤더와 바디를 구분한다.
- 바디가 항상 존재한다고는 할 수 없다.

- **메시지 헤더**: 서버와 클라이언트가 꼭 처리해야 하는 리퀘스트와 리스폰스 내용과 속성 등
  - field-name은 대소문자 구분 없음
  - HTTP 전송에 필요한 모든 부가 정보가 있음
  - 예) 메시지 바디 내용, 크기, 압축, 인증, 요청 클라이언트 정보, 서버 애플리케이션 정보, 캐시 관리 정보...
  - 표준 헤더가 너무 많음
  - 필요 시 임의의 헤더 추가 가능
- CR (carriage return) LF (line feed)
- **메시지 바디**: 꼭 전송되는 데이터 그 자체

## 리퀘스트 메시지와 리스폰스 메시지의 구조
![image](https://user-images.githubusercontent.com/78652144/168461501-2e88e5e6-44d6-4c92-b1bb-ee34a1263a6e.png)

- **리퀘스트 라인**(요청 메시지의 시작 라인): 리퀘스트에 사용하는 메소드와 URI, HTTP 버전이 포함되어 있다.
- **상태 라인**(응답 메시지의 시작 라인): 리스폰스 결과를 나타내는 상태 코드와 설명, HTTP 버전이 포함된다.
- **헤더 필드**: 리퀘스트, 리스폰스의 여러 조건과 속성 등을 나타낸다.
    - 일반, 리퀘스트, 리스폰스, 엔티티 헤더 필드 등 4종류가 있다.
- **공백 라인**: 요청에 대한 모든 메타 정보가 전송되었음을 알리는 빈 줄
- 그 외 RFC에는 없는 헤더 필드(쿠키 등)가 포함되는 경우가 있다.

## 인코딩으로 전송 효율을 높이다.
- HTTP 데이터를 전송할 때 인코딩(변환)을 실시함으로써 전송 효율을 높일 수 있다.
- 인코딩을 하면 다량의 엑세스를 효율 좋게 처리할 수 있다.
- 다만 CPU 리소스는 많이 소비하게 된다.

### 메시지 바디와 엔티티 바디의 차이
- 메시지: HTTP 통신의 기본 단위로 옥텟 시퀸스로 구성되고 통신을 통해 전송된다.
- 엔티티: 리퀘스트랑 리스폰스의 페이로드(부가물)로 전송되는 정보로 엔티티 헤더 필드와 엔티티 바디로 구성된다.
- HTTP 메시지 바디는 요청, 응답의 엔티티 바디를 운반한다.
- 기본적으로 메시지바디 = 엔티티바디
- 하지만 전송 코딩이 적용된 경우 엔티티 바디의 내용이 변화하여 메시지 바디와 달라진다.

### 압축해서 보내는 콘텐츠 코딩
- 콘텐츠 코딩은 엔티티에 적용하는 인코딩을 가리키는데 엔티티 정보를 유지한채 압축한다. (클라이언트에서 디코딩) 

### 분해해서 보내는 청크 전송 코딩
- 사이즈가 큰 데이터를 전송하는 경우 엔티티 바디를 분할할 수 있다.
- 이렇게 엔티티 바디를 분할하는 기능을 **청크 전송 코딩**이라고 한다.

## 여러 데이터를 보내는 멀티파트
- 멀티파트는 여러 다른 종류의 데이터를 수용한다.
- HTTP는 멀티 파트에 대응하고 있어 하나의 메시지 바디 내부에 엔티티를 여러 개 포함시켜 보낼 수 있다.

- multipart/form-data  
  - Web form으로부터 파일 업로드에 사용된다.
    
- multipart/byteranges
  - 상태 코드 206(Partial Content) 리스폰스 메시지가 복수 범위의 내용을 포함할 때 사용된다.
    

- 멀티파트를 사용할 때 Content-type 헤더 필드를 사용한다.
- 멀티파트는 파트마다 헤더 필드가 포함된다.

## 일부분만 받는 레인지 리퀘스트
- 옛날엔 대용량 데이터를 다운할 때 커넥션이 끊기면 처음부터 다시 받아야 했다. 
- 이전 다운로드부터 다운로드를 재개하기 위해선 엔티티 범위를 지정할 필요가 있다.
- 이와 같이 범위를 지정하여 리퀘스트하는 것을 **레인지 리퀘스트**라고 한다.
- Range 헤더 필드를 사용해서 리소스의 바이트 레인지를 지정한다.
- Range: bytes = 5001-10000
- 레인지 리퀘스트에 대한 상태코드는 206 Partial Content라는 리스폰스 메시지가 돌아온다. (복수 범위의 대한건 multipart/byteranges)

## 컨텐츠 네고시에이션
- 컨텐츠 네고시에이션이란 클라이언트와 서버가 제공하는 리소스의 내용에 대해서 교섭하는 것이다.
- 제공하는 리소스를 언어와 문자 세트, 인코딩 방식 등을 기준으로 판단한다.
- 판단 기준은 다음 리퀘스트 헤더 필드이다.
  - Accept: 클라이언트가 선호하는 미디어 타입 전달
  - Accept-Charset: 클라이언트가 선호하는 문자 인코딩
  - Accept-Encoding: 클라이언트가 선호하는 압축 인코딩
  - Accept-Language: 클라이언트가 선호하는 자연 언어
  - Content-Language: 사용자의 언어를 뜻하며 요청이나 응답이 무슨 언어인지는 관련 없음
  ![image](https://user-images.githubusercontent.com/78652144/168462975-9c002f9f-9d40-49da-b753-f33c80a27959.png)

### 서버 구동형 네고시에이션
- 서버 측에서 네고시에이션을 하는 방식
- 브라우저가 보내는 정보를 근거로 하기 때문에 정말로 유저에게 적절한 것이 선택되었다고 할 수 없음

### 에이전트 구동형 네고시에이션
- 클라이언트 측에서 네고시에이션을 하는 방식
- 유저가 수동으로 선택

### 트랜스페이런트 네고시에이션 (Transparent Negotiation)
- 서버 구동형과 에이전트 구동형을 혼합한 것으로 서버와 클라이언트가 각각 네고시에이션을 하는 방식
